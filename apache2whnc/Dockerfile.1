# Dockerfile for apache2whnc

FROM debian:stretch-slim

LABEL maintainer "oliver.eberlein@netcologne.de"

RUN echo "deb http://debian.netcologne.de/debian/ stretch main contrib non-free" > /etc/apt/sources.list
RUN echo "deb http://debian.netcologne.de/debian-security stretch/updates main contrib non-free" >> /etc/apt/sources.list

# install packages

RUN apt-get update

RUN apt-get install apt-utils aptitude -y locales net-tools procps git curl wget vim
RUN apt-get install -y apache2 libapache2-mod-fcgid apache2-suexec-custom
RUN apt-get install libnss-extrausers

RUN rm -rf /var/lib/apt/lists/* 
RUN localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8
ENV LANG en_US.utf8


# setup apache2

RUN rm /etc/apache2/sites-enabled/*
RUN /usr/sbin/a2ensite 000-default

ADD files/etc/apache2/conf-available /etc/apache2/conf-available
ADD files/etc/apache2/sites-available /etc/apache2/sites-available

RUN /usr/sbin/a2enconf servername
RUN /usr/sbin/a2enconf apachelogs
RUN /usr/sbin/a2disconf other-vhosts-access-log
RUN /usr/sbin/a2enmod suexec

RUN chmod 755 /var/log/apache2

RUN /usr/sbin/a2enmod fcgid
ADD files/etc/apache2/mods-available/fcgid.conf /etc/apache2/mods-available/fcgid.conf


# copy content

COPY files/var/www/html/ /var/www/html/
RUN mkdir /var/www/php
RUN chown -R 10000000:10000 /var/www
COPY --chown=10000000:10000 files/var/www/php/php5-fcgi /var/www/php/php5-fcgi
RUN chmod 755 /var/www/php/php5-fcgi


# libnss-extrausers
COPY files/etc/nsswitch.conf /etc/nsswitch.conf
COPY files/singlefiles/passwd /var/lib/extrausers/passwd
COPY files/singlefiles/config.php73 /root
RUN groupadd -g 10000 www

# prevent Debian's PHP packages from being installed
# https://github.com/docker-library/php/pull/542
RUN set -eux; \
	{ \
		echo 'Package: php*'; \
		echo 'Pin: release *'; \
		echo 'Pin-Priority: -1'; \
	} > /etc/apt/preferences.d/no-debian-php

# dependencies required for running "phpize"
# (see persistent deps below)
ENV PHPIZE_DEPS \
		autoconf \
		dpkg-dev \
		file \
		g++ \
		gcc \
		libc-dev \
		make \
		pkg-config \
		re2c


# persistent / runtime deps
RUN apt-get update && apt-get install -y \
		$PHPIZE_DEPS \
		ca-certificates \
		curl \
		xz-utils \
        apt aptitude apt-utils \
	--no-install-recommends && rm -r /var/lib/apt/lists/*


ENV PHP_URL="https://secure.php.net/get/php-7.3.3.tar.xz/from/this/mirror"

RUN set -eux; \
	mkdir -p /usr/src/php; \
	cd /usr/src; \
	wget -O php.tar.xz "$PHP_URL"; \
    tar -Jxf /usr/src/php.tar.xz -C /usr/src/php --strip-components=1

RUN set -eux; \
	apt-get update; \
	apt-get install -y \
		libcurl4-openssl-dev \
		libedit-dev \
		libsodium-dev \
		libsqlite3-dev \
		libssl-dev \
		libxml2-dev \
		zlib1g-dev \
        libzip-dev \
        libbz2-dev \
        libgdbm-dev \
        libgd3 \
        libgd2-xpm-dev \
        libgd-dev \
        libc-client2007e-dev \
        libkrb5-dev \
        libpq-dev \
        libpspell-dev \
        libtidy-dev \
        libxslt1-dev




#ENTRYPOINT ["docker-php-entrypoint"]
##<autogenerated>##
#CMD ["php", "-a"]
##</autogenerated>##

CMD ["/usr/sbin/apache2ctl", "-D", "FOREGROUND"]

